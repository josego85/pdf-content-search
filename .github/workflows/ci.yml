name: CI

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'fix/**'
      - 'claude/**'
  pull_request:
    branches:
      - main
      - develop

permissions:
  contents: read

jobs:
  php-tests:
    name: PHP Tests (PHP ${{ matrix.php }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        php: ['8.4']

    services:
      elasticsearch:
        image: elasticsearch:9.2.2
        env:
          discovery.type: single-node
          xpack.security.enabled: false
          ES_JAVA_OPTS: "-Xms512m -Xmx512m"
        ports:
          - 9200:9200
        options: >-
          --health-cmd "curl -f http://localhost:9200/_cluster/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v5.0.0

      - name: Setup PHP project
        uses: ./.github/actions/setup-php-project
        with:
          php-version: ${{ matrix.php }}
          extensions: 'ctype, iconv, pdo, pdo_pgsql, pdo_sqlite, mbstring, xml, intl, zip'
          coverage: pcov

      - name: Validate composer files
        run: composer validate --no-check-publish

      - name: Setup Node.js project
        uses: ./.github/actions/setup-node-project

      - name: Build frontend assets
        run: npm run build

      - name: Wait for Elasticsearch
        run: |
          timeout 60 bash -c 'until curl -s http://localhost:9200/_cluster/health | grep -q "green\|yellow"; do sleep 1; done'

      - name: Run All Tests with Coverage
        run: vendor/bin/phpunit --coverage-clover coverage.xml --testdox

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
          verbose: true

      - name: Check code coverage threshold
        run: |
          COVERAGE=$(php -r "
          \$xml = simplexml_load_file('coverage.xml');
          \$metrics = \$xml->project->metrics;
          \$lines = (int)\$metrics['statements'];
          \$covered = (int)\$metrics['coveredstatements'];
          \$percentage = (\$lines > 0) ? (\$covered / \$lines) * 100 : 0;
          echo number_format(\$percentage, 2);
          ")
          echo "Code coverage (line): ${COVERAGE}%"
          if (( $(echo "$COVERAGE < 85" | bc -l) )); then
            echo "❌ Coverage ${COVERAGE}% is below 85% threshold"
            exit 1
          fi
          echo "✅ Coverage ${COVERAGE}% meets 85% threshold"

  code-style:
    name: PHP Code Style
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v5.0.0

      - name: Setup PHP project
        uses: ./.github/actions/setup-php-project

      - name: Fix autogenerated files code style
        run: composer cs-fix -- config/reference.php

      - name: Run PHP-CS-Fixer
        run: composer cs-check

  frontend-build:
    name: Frontend Build & Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v5.0.0

      - name: Setup Node.js project
        uses: ./.github/actions/setup-node-project

      - name: Build frontend assets
        run: npm run build

      - name: Verify build artifacts
        run: |
          if [ ! -d "public/build" ]; then
            echo "Build directory not found!"
            exit 1
          fi
          echo "Build completed successfully"
