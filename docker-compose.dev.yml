# ============================================
# Docker Compose - DEVELOPMENT Configuration
# ============================================
# Explicit development overrides (replaces override.yml)
# Usage: make dev  OR  docker compose -f docker-compose.yml -f docker-compose.dev.yml up
# ============================================

services:
  database:
    ports:
      - "5432:5432"
    restart: "no"

  apache:
    image: httpd:2.4.66
    ports:
      - "80:80"
    volumes: !override
      - .:/var/www/html
      - ./.docker/dev/apache/apache.conf:/usr/local/apache2/conf/httpd.conf
      - ./.docker/dev/apache/vhost.conf:/usr/local/apache2/conf/extra/httpd-vhosts.conf
    restart: "no"

  php:
    build:
      context: .
      dockerfile: .docker/dev/app/Dockerfile
      args:
        USER_ID: ${USER_ID:-1000}
        GROUP_ID: ${GROUP_ID:-1000}
    volumes: !override
      - .:/var/www/html
      - ./.docker/dev/php/php.ini:/usr/local/etc/php/php.ini
    environment:
      - APP_ENV=dev
      - APP_DEBUG=1
      - XDEBUG_MODE=${XDEBUG_MODE:-off}
      # Override: disable ES auth in development
      - ELASTICSEARCH_HOST=http://elasticsearch:9200
    restart: "no"

  elasticsearch:
    ports:
      - "9200:9200"
    environment:
      - discovery.type=single-node
      - cluster.name=docker-cluster
      - bootstrap.memory_lock=true
      # Disable auth for easier development
      - xpack.security.enabled=false
      - xpack.security.enrollment.enabled=false
      - ES_JAVA_OPTS=-Xms1g -Xmx1g
      - cluster.routing.allocation.disk.threshold_enabled=false
      - action.destructive_requires_name=false
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9200/_cluster/health | grep -q 'yellow\\|green'"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: "no"

  ollama:
    ports:
      - "11435:11434"
    volumes:
      - ./bin/download-models.sh:/usr/local/bin/download-models.sh:ro
      - ollama_data:/root/.ollama
    healthcheck:
      test: ["CMD-SHELL", "/usr/local/bin/download-models.sh"]
      interval: 30s
      timeout: 120s
      retries: 3
      start_period: 60s
    restart: "no"
