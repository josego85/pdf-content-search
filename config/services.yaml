# This file is the entry point to configure your own services.
# Files in the packages/ subdirectory configure your dependencies.

# Put parameters here that don't need to change on each machine where the app is deployed
# https://symfony.com/doc/current/best_practices.html#use-parameters-for-application-configuration
parameters:
    elasticsearch.index_pdfs: '%env(ELASTICSEARCH_INDEX_PDFS)%'

services:
    # default configuration for services in *this* file
    _defaults:
        autowire: true      # Automatically injects dependencies in your services.
        autoconfigure: true # Automatically registers your services as commands, event subscribers, etc.

    # makes classes in src/ available to be used as services
    # this creates a service per class whose id is the fully-qualified class name
    App\:
        resource: '../src/'
        exclude:
            - '../src/DependencyInjection/'
            - '../src/Entity/'
            - '../src/Kernel.php'

    # add more service definitions when explicit configuration is needed
    # please note that last definitions always *replace* previous ones

    App\Service\ElasticsearchService:
        arguments:
            $host: '%env(ELASTICSEARCH_HOST)%'
            $pdfPagesIndex: '%elasticsearch.index_pdfs%'

    App\Contract\SearchEngineInterface: '@App\Service\ElasticsearchService'
    App\Contract\PdfIndexerInterface: '@App\Service\ElasticsearchService'

    # Vector store service - abstraction for vector databases
    # Makes it easy to switch from Elasticsearch to Pinecone, Weaviate, Qdrant, etc.
    App\Service\ElasticsearchVectorStore:
        arguments:
            $client: '@.service_locator.elasticsearch_client'
            $indexName: '%elasticsearch.index_pdfs%'
            $dimensions: 768

    # Bind interface to implementation (Dependency Inversion)
    App\Contract\VectorStoreInterface: '@App\Service\ElasticsearchVectorStore'

    # Service locator for Elasticsearch client (shared with ElasticsearchService)
    .service_locator.elasticsearch_client:
        class: Closure
        factory: ['@App\Service\ElasticsearchService', 'getClient']

    # Search services - SOLID architecture
    App\Search\QueryParser: ~

    App\Search\SearchQueryBuilder:
        arguments:
            $pdfPagesIndex: '%elasticsearch.index_pdfs%'

    App\Search\HybridSearchQueryBuilder:
        arguments:
            $lexicalBuilder: '@App\Search\SearchQueryBuilder'
            $pdfPagesIndex: '%elasticsearch.index_pdfs%'

    # Bind interface to implementation (Dependency Inversion Principle)
    # Using HybridSearchQueryBuilder to support both lexical and semantic search
    App\Contract\QueryBuilderInterface: '@App\Search\HybridSearchQueryBuilder'

    # Translation services
    App\Service\TranslationRequestValidator:
        arguments:
            $pdfsDirectory: '%kernel.project_dir%/public/pdfs'

    App\Service\TranslationService:
        arguments:
            $translationCacheTtl: '%translation.cache_ttl%'

    App\Service\QueueDuplicationChecker:
        arguments:
            $dedupTtl: '%queue.deduplication_ttl%'

    App\Service\OllamaService:
        arguments:
            $ollamaHost: '%ollama.host%'
            $ollamaModel: '%ollama.model%'
            $ollamaTimeout: '%ollama.timeout%'
            $ollamaTemperature: '%ollama.temperature%'
            $ollamaMaxTokens: '%ollama.max_tokens%'

    # Embedding service for semantic search
    App\Service\OllamaEmbeddingService:
        arguments:
            $ollamaHost: '%ollama.host%'
            $embeddingModel: '%ollama.embedding_model%'
            $dimensions: 768

    # Bind interface to implementation for embeddings
    App\Contract\EmbeddingServiceInterface: '@App\Service\OllamaEmbeddingService'

    # Rank fusion service for hybrid search
    App\Service\ReciprocalRankFusionService: ~
    App\Contract\RankFusionServiceInterface: '@App\Service\ReciprocalRankFusionService'